trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  aksResourceGroup: 'RG02'
  aksClusterName: 'RG02-AKS1'
  subscriptionId: 'aab3378c-ce10-4a02-a67f-bd35bc48e60f'
  objectId: '1a0227bc-6295-4d6a-9586-c13ec5c262f5'
  prometheusNamespace: 'monitoring'
  azureADClientId: 'cf968ae1-6deb-454f-8244-993b7c8a864f' # Substitua pelo Client ID da sua App Registration
  azureADTenantId: 'b7a7b567-4287-48aa-9755-ec5b5ec68021' # Substitua pelo Tenant ID da sua organização
  grafanaAdminPassword: 'admin' # Ou outra senha desejada
  grafanaAzureADClientSecret: '$(grafana-azuread-client-secret)' # Referência à variável secreta

stages:
- stage: DeployMonitoring
  jobs:
  - job: Deploy
    steps:
    - task: AzureCLI@2
      displayName: '🔐 Criar Secret para Client Secret do Azure AD'
      inputs:
        azureSubscription: 'Terraform-automation'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -e

          echo "🔑 Obtendo credenciais do AKS..."
          KUBECONFIG=$(mktemp)
          az aks get-credentials --resource-group "$(aksResourceGroup)" --name "$(aksClusterName)" --file "$KUBECONFIG" --overwrite-existing

          echo "📝 Definindo a variável de ambiente KUBECONFIG..."
          export KUBECONFIG="$KUBECONFIG"

          echo "🔎 Verificando contexto do kubectl ANTES da criação do Secret..."
          kubectl config current-context
          kubectl cluster-info

          echo "🔑 Criando Kubernetes Secret 'grafana-azuread-secret' no namespace '$(prometheusNamespace)'..."
          kubectl create secret generic grafana-azuread-secret \
            --namespace=$(prometheusNamespace) \
            --from-literal=client-secret="$AZUREADCLIENTSECRETVALUE" \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "✅ Secret criado com sucesso."
        
    - task: AzureCLI@2
      displayName: '⚙️ Criar ConfigMap para Configuração do Grafana Azure AD'
      inputs:
        azureSubscription: 'Terraform-automation'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -e

          echo "🔑 Obtendo credenciais do AKS..."
          KUBECONFIG=$(mktemp)
          az aks get-credentials --resource-group "$(aksResourceGroup)" --name "$(aksClusterName)" --file "$KUBECONFIG" --overwrite-existing

          echo "📝 Definindo a variável de ambiente KUBECONFIG..."
          export KUBECONFIG="$KUBECONFIG"

          echo "🔎 Verificando contexto do kubectl ANTES da criação do ConfigMap..."
          kubectl config current-context
          kubectl cluster-info

          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-azuread-config
            namespace: $(prometheusNamespace)
          data:
            grafana.ini: |
              [auth.azuread]
              enabled = true
              client_id = "$(azureADClientId)"
              client_secret = "$(GRAFANA_CLIENT_SECRET)"
              tenant_id = "$(azureADTenantId)"
              auth_url = "https://login.microsoftonline.com/$(azureADTenantId)/oauth2/authorize"
              token_url = "https://login.microsoftonline.com/$(azureADTenantId)/oauth2/token"
              allowed_domains =
              allow_sign_up = true
              auto_login = false
              name = Azure AD
              role_attribute_path =
              groups_attribute_path =
              email_attribute_path =
              login_attribute_path =
          EOF
          echo "✅ ConfigMap grafana-azuread-config criado com sucesso."
        
    - task: AzureCLI@2
      displayName: '🔧 Configurar AKS e instalar Prometheus/Grafana'
      inputs:
        azureSubscription: 'Terraform-automation'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -e

          echo "🔐 Garantindo permissões de Cluster Admin..."
          az role assignment create \
            --assignee "$(objectId)" \
            --role "Azure Kubernetes Service Cluster Admin Role" \
            --scope /subscriptions/$(subscriptionId)/resourceGroups/$(aksResourceGroup)/providers/Microsoft.ContainerService/managedClusters/$(aksClusterName) \
            || echo "Permissão já atribuída ou já existente."

          echo "🔧 Acessando o cluster AKS..."
          az aks get-credentials --resource-group $(aksResourceGroup) --name $(aksClusterName) --overwrite-existing

          echo "🔎 Verificando contexto do kubectl..."
          kubectl config current-context
          kubectl cluster-info

          echo "📁 Criando namespace '$(prometheusNamespace)'..."
          kubectl create namespace $(prometheusNamespace) --dry-run=client -o yaml | kubectl apply -f -

          echo "📦 Adicionando repositórios Helm..."
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

          echo "📈 Instalando Prometheus..."
          helm upgrade --install prometheus prometheus-community/prometheus \
            --namespace $(prometheusNamespace) \
            --set server.service.type=LoadBalancer

          echo "📊 Instalando Grafana..."
          helm upgrade --install grafana grafana/grafana \
            --namespace $(prometheusNamespace) \
            --set adminPassword="$(grafanaAdminPassword)" \
            --set service.type=LoadBalancer \
            --set "volumes[0].name"="grafana-config" \
            --set "volumes[0].configMap.name"="grafana-azuread-config" \
            --set "volumes[1].name"="grafana-secrets" \
            --set "volumes[1].secret.secretName"="grafana-azuread-secret" \
            --set "volumeMounts[0].name"="grafana-config" \
            --set "volumeMounts[0].mountPath"="/etc/grafana/grafana.ini" \
            --set "volumeMounts[0].subPath"="grafana.ini" \
            --set "volumeMounts[1].name"="grafana-secrets" \
            --set "volumeMounts[1].mountPath"="/etc/grafana/grafana.ini" \
            --set "volumeMounts[1].subPath"="client-secret"

          echo "⏳ Verificando recursos..."
          kubectl get all -n $(prometheusNamespace)